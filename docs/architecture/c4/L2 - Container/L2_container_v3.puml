@startuml L2_container_v3
left to right direction

skinparam rectangle {
    BackgroundColor<<container>> #438dd5
    FontColor<<container>> #ffffff
    BorderColor<<container>> #3c7fc0
    BackgroundColor<<database>> #1168bd
    FontColor<<database>> #ffffff
    BorderColor<<database>> #0e4f96
    BackgroundColor<<external>> #999999
    FontColor<<external>> #ffffff
    BorderColor<<external>> #888888
}
skinparam actor {
    BackgroundColor<<user>> #08427b
    FontColor<<user>> #ffffff
    BorderColor<<user>> #073b6e
}
skinparam ArrowColor #666666
skinparam FontName SansSerif

title Container Diagram for Crypto-Sentiment-Pulse (Data Flow Emphasis)

together {
    actor "Crypto Trader" <<user>> as user
    rectangle "Frontend UI\n[Vue 3 SPA]\n:3000" <<container>> as frontend
}

together {
    rectangle "Backend API\n[FastAPI]\nBroadcasts live events" <<container>> as backend
    rectangle "Celery Worker\n[Python]\nExecutes & persists tasks" <<container>> as celery_worker
    rectangle "Celery Beat\n[Python]\nSchedules periodic tasks" <<container>> as celery_beat
}

together {
    rectangle "Crypto Service\n[Python]\nBinance Streamer" <<container>> as crypto_service
    rectangle "News Service\n[Python]\nTG / Panic Scraper" <<container>> as news_service
}

together {
    database "Redis\n[Real-time Bus]\n:6379" <<database>> as redis
    database "PostgreSQL\n[Historical DB]\n:5432" <<database>> as db
}

together {
    rectangle "Binance" <<external>> as binance
    rectangle "Telegram" <<external>> as telegram
    rectangle "CryptoPanic" <<external>> as cryptopanic
}

' Force vertical stacking
celery_worker    -[hidden]down-> celery_beat
crypto_service   -[hidden]down-> news_service
binance          -[hidden]down-> telegram
telegram         -[hidden]down-> cryptopanic
redis            -[hidden]down-> db

' User flow
user             <-[#blue,bold]-     frontend        : "Live price updates, charts"
frontend         <-[#blue,bold]-     backend         : "WebSocket: price ticks, messages"

' Backend
backend          <-[#green,dashed]-  redis           : "Subscribe: crypto:updates, news:*"
backend          -[#orange,dashed]-> db              : "Query: Historical OHLCV, news"

' Celery Worker — consumes tasks, writes to DB
celery_worker    <-[#green,dashed]-  redis           : "BRPOP: persist_message, fetch_ohlcv"
celery_worker    -[#orange,dashed]-> db              : "Insert: Tickers, Messages, News"

' Celery Beat — only schedules
celery_beat      -[#green,dashed]->  redis           : "LPUSH: periodic task schedule"

' Crypto Service — has DATABASE_URL, publishes + stores
crypto_service   -[#green,dashed]->  redis           : "Publish: Ticker events (prices)"
crypto_service   -[#orange,dashed]-> db              : "Insert: OHLCV rows"
crypto_service   <-[#gray,dashed]-   binance         : "Ticker stream (BTC/ETH...)"

' News Service — NO DATABASE_URL, only Redis + external
news_service     -[#green,dashed]->  redis           : "Publish: TG messages, news items"
news_service     <-[#gray,dashed]-   telegram        : "Raw messages, media (MTProto)"
news_service     <-[#gray,dashed]-   cryptopanic     : "News articles (HTTPS/REST)"

@enduml