@startuml L1_sequence_system
skinparam sequence {
    ActorBackgroundColor #08427b
    ActorFontColor #ffffff
    ParticipantBackgroundColor #438dd5
    ParticipantFontColor #ffffff
    ParticipantBorderColor #3c7fc0
    DatabaseBackgroundColor #1168bd
    DatabaseFontColor #ffffff
    ArrowColor #666666
    LifeLineBorderColor #666666
    BoxBackgroundColor #f5f5f5
    BoxBorderColor #cccccc
}
skinparam FontName SansSerif

title System Interaction Sequence Diagram (L1)

actor "Browser" as user
participant "Frontend\n[Vue/Nginx]" as frontend
participant "Backend\n[FastAPI]" as backend
participant "CryptoService\n[Python]" as crypto
participant "NewsService\n[Python]" as news
participant "CeleryWorker\n[Task Queue]" as celery
database "Redis" as redis
database "PostgreSQL" as db
participant "BinanceWS" as binance
participant "TelegramMTProto" as tg
participant "CryptoPanicAPI" as panic

== Scenario 1 — System Startup ==

note over db        : 1. PostgreSQL init\npg_isready healthcheck
note over redis     : 2. Redis started\n:6379 ready
note over crypto    : 3. CryptoService starts\n(depends on db + redis)
note over news      : 3. NewsService starts\n(depends on redis)
note over backend   : 4. Backend starts\n(depends on db + redis + crypto)
note over celery    : 4. Celery Worker/Beat start\n(depends on db + redis + backend)
note over frontend  : 5. Frontend starts\n(depends on backend)

== Scenario 2 — User Opens Dashboard ==

user        ->      frontend    : Load SPA
activate frontend
frontend    -->     user        : Serve static assets
deactivate frontend

user        ->      backend     : GET /api/v1/prices
activate backend
backend     ->      redis       : GET crypto:prices (cache)
alt Cache hit
    redis   -->     backend     : Cached prices JSON
else Cache miss
    backend ->      db          : SELECT PriceHistory
    db      -->     backend     : OHLCV rows
end
backend     -->     user        : 200 JSON prices
deactivate backend

user        ->      backend     : GET /api/v1/news
activate backend
backend     ->      db          : SELECT CryptoPanicNews
db          -->     backend     : Latest headlines
backend     -->     user        : 200 JSON news
deactivate backend

user        ->      backend     : GET /api/v1/sentiment/fear-greed
activate backend
backend     ->      redis       : GET crypto:fear_greed
alt Key exists
    redis   -->     backend     : Fear & Greed JSON
else Cold start — key missing
    backend -->     user        : 200 JSON {value: 50, label: "Neutral"}
    note right of backend : Fallback default\nto avoid 500
end
backend     -->     user        : 200 JSON sentiment
deactivate backend

user        ->      backend     : WS Upgrade /ws
activate backend
backend     -->     user        : 101 Switching Protocols
note right of backend : Connection stored\nin active_connections

== Scenario 3 — Live Price Update ==

binance     ->      crypto      : WSS Ticker event (BTC/ETH...)
activate crypto
crypto      ->      crypto      : Normalize & process
crypto      ->      db          : INSERT PriceHistory (bulk 5s)
crypto      ->      redis       : PUBLISH crypto:updates\n{prices, fear_greed}
deactivate crypto

note right of redis : Backend asyncio\nsubscriber wakes up
redis       ->      backend     : Message received on crypto:updates
backend     ->      user        : WS PUSH {type: "update", data: {...}}

== Scenario 4 — News & Telegram Flow ==

tg          ->      news        : NewMessage event (MTProto)
activate news
news        ->      news        : Parse & extract metadata
news        ->      redis       : PUBLISH news:telegram {text, meta}
deactivate news

panic       ->      news        : REST poll response (interval)
activate news
news        ->      redis       : PUBLISH news:cryptopanic {title, url}
deactivate news

note right of redis : Celery Worker\nBRPOP — picks up tasks
redis       ->      celery      : Task dequeued\n[persist_telegram_message]
activate celery
celery      ->      db          : INSERT/UPSERT news record
deactivate celery

redis       ->      celery      : Task dequeued\n[fetch_and_persist_news]
activate celery
celery      ->      db          : INSERT/UPSERT news record
deactivate celery

note right of redis : Backend asyncio\nsubscriber wakes up
redis       ->      backend     : Message received on news:*
backend     ->      user        : WS PUSH {type: "news", data: {...}}
deactivate backend

@enduml